@page "/OpenStream"
@inject Microsoft.AspNetCore.Components.NavigationManager NavMan
@using Microsoft.AspNetCore.Http
@using System.IO;
@namespace FileManager.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers


@{
    string url;
    int time;
    try
    {

        Console.WriteLine($"Partial Request {Request.Headers["Range"]}");

        string q = HttpContext.Request.QueryString.Value.TrimStart('?');
        int splitAt = q.IndexOf(':');
        if (splitAt != -1)
        {
            if (int.TryParse(q.Substring(0, splitAt), out time))
            {
                url = Uri.UnescapeDataString(q.Substring(splitAt + 1)).Trim('"');
            }
            else
            {
                time = 0;
                url = Uri.UnescapeDataString(q.TrimStart('?')).Trim('"');
            }
        }
        else
        {
            time = 0;
            url = Uri.UnescapeDataString(q.TrimStart('?')).Trim('"');
        }


        Console.WriteLine($"Streaming {url} at {time}%");

    }
    catch (Exception ex)
    {
        //TODO: Use more understandable err msgs
        Console.WriteLine("Path error " + ex.Message);
        await Response.WriteAsync("Path error " + ex.Message);
        return;
    }

    FileStream FS;
    try
    {
        FS = System.IO.File.Open(url, FileMode.Open, FileAccess.Read, FileShare.Read);
    }
    catch (Exception ex)
    {
        //TODO: Use more understandable err msgs
        Console.WriteLine("Opening error " + url + " >> " + ex.Message);
        await Response.WriteAsync("Opening error " + url + " >> " + ex.Message);
        return;
    }
    long L = FS.Length;
    if (time > 0 && FS.CanSeek)
    {
        long Pos = (long)(L * (time / 100f));
        FS.Seek(Pos, SeekOrigin.Begin);
    }

    Response.Headers.Add("Accept-Ranges", "bytes");
    Response.ContentType = "video/mp4";
    Response.Headers.Add("Content-Length", L.ToString());

    // HttpContext.Response.Headers.Clear();
    await FS.CopyToAsync(HttpContext.Response.BodyWriter.AsStream(true));
    FS.Dispose();
}
